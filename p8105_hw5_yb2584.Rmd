---
title: "p8105_hw5_yb2584"
author: "Yunshen Bai"
date: "`r Sys.Date()`"
output: github_document
---
```{r,message=FALSE,warning=FALSE}
library(tidyverse)
library(rvest)
library(dplyr)
library(tidyr)
```

## Problem 1
For this problem, we are interested in data gathered and made public by _The Washington Post_ on homicides in 50 large U.S. cities. The code chunk below imports and cleans the data.

```{r}
homicide_df = 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>%
  mutate(
    city_state = str_c(city, state, sep = ", "),
    resolution = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved"
    )
  ) %>% 
  filter(city_state != "Tulsa, AL") 
```

The resulting dataframe has `r nrow(homicide_df)` entries, on variables that include the victim name, race, age, and sex; the date the homicide was reported; and the location of the homicide. In cleaning, I created a `city_state` variable that includes both city and state, and a `resolution` variable to indicate whether the case was closed by arrest. I also excluded one entry in Tulsa, AL, which is not a major US city and is most likely a data entry error. 

In the next code chunk, I group within cities and summarize to produce the total number of homicides and the number that are solved. 

```{r}
city_homicide_df = 
  homicide_df %>% 
  select(city_state, disposition, resolution) %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolution == "unsolved"))
```

Focusing only on Baltimore, MD, I can use the `prop.test` and `broom::tidy` functions to obtain an estimate and CI of the proportion of unsolved homicides in that city. The table below shows those values.

```{r}
bmore_test = 
  prop.test(
    x = filter(city_homicide_df, city_state == "Baltimore, MD") %>% pull(hom_unsolved),
    n = filter(city_homicide_df, city_state == "Baltimore, MD") %>% pull(hom_total)) 

broom::tidy(bmore_test) %>% 
  knitr::kable(digits = 3)
```

Building on this code, I can use functions in the `purrr` package to obtain estimates and CIs for the proportion of unsolved homicides in each city in my dataset. The code below implements this analysis. 

```{r}
test_results = 
  city_homicide_df %>% 
  mutate(
    prop_tests = map2(hom_unsolved, hom_total, \(x, y) prop.test(x = x, n = y)),
    tidy_tests = map(prop_tests, broom::tidy)) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high) %>% 
  mutate(city_state = fct_reorder(city_state, estimate))
```

Finally, I make a plot showing the estimate (and CI) of the proportion of unsolved homicides in each city.

```{r}
test_results %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

This figure suggests a very wide range in the rate at which homicides are solved -- Chicago is noticeably high and, given the narrowness of the CI, likely is the location of many homicides. 

## Problem 2
```{r,message=FALSE}
files_name=list.files("./data/data")
setwd("C:/Users/Leon/Desktop/p8105_hw5_yb2584/data/data")
output=map(files_name,read_csv)
```


```{r}
dt=
  do.call(rbind.data.frame, output)|>
  mutate(arm=str_remove(files_name,".csv"))|>
  select(arm,everything())
```

```{r}
dt|>
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "value"
  )|>
  mutate(num=rep(1:8,20))|>
ggplot(aes(x=num,y=value,color=arm))+
  geom_point()+
  geom_line()+
  scale_x_continuous(
    breaks = 1:8, 
    labels = c("Week 1","Week 2","Week 3","Week4","Week 5","Week 6","Week 7","Week 8"))+
  labs(
    x="Week",
    y="Value",
    color="Arm"
  )+
  theme(legend.position = "bottom")
```



## Problem 3

```{r}
est_mu=rep(0,5000)
p_val=rep(0,5000)
for(i in 1:5000)
{
  sam=rnorm(30,0,5)
  res=t.test(sam,mu=0)
  est_mu[i]=mean(sam)
  p_val[i]=broom::tidy(res)$p.value
}
mu_0=data.frame(est_mu,p_val)
```


```{r}
est_mu=rep(0,5000)
p_val=rep(0,5000)
for(i in 1:5000)
{
  sam=rnorm(30,1,5)
  res=t.test(sam,mu=1)
  est_mu[i]=mean(sam)
  p_val[i]=broom::tidy(res)$p.value
}
mu_1=data.frame(est_mu,p_val)
```

```{r}
est_mu=rep(0,5000)
p_val=rep(0,5000)
for(i in 1:5000)
{
  sam=rnorm(30,2,5)
  res=t.test(sam,mu=2)
  est_mu[i]=mean(sam)
  p_val[i]=broom::tidy(res)$p.value
}
mu_2=data.frame(est_mu,p_val)
```


```{r}
est_mu=rep(0,5000)
p_val=rep(0,5000)
for(i in 1:5000)
{
  sam=rnorm(30,3,5)
  res=t.test(sam,mu=3)
  est_mu[i]=mean(sam)
  p_val[i]=broom::tidy(res)$p.value
}
mu_3=data.frame(est_mu,p_val)
```


```{r}
est_mu=rep(0,5000)
p_val=rep(0,5000)
for(i in 1:5000)
{
  sam=rnorm(30,4,5)
  res=t.test(sam,mu=4)
  est_mu[i]=mean(sam)
  p_val[i]=broom::tidy(res)$p.value
}
mu_4=data.frame(est_mu,p_val)
```


```{r}
est_mu=rep(0,5000)
p_val=rep(0,5000)
for(i in 1:5000)
{
  sam=rnorm(30,5,5)
  res=t.test(sam,mu=5)
  est_mu[i]=mean(sam)
  p_val[i]=broom::tidy(res)$p.value
}
mu_5=data.frame(est_mu,p_val)
```


```{r}
est_mu=rep(0,5000)
p_val=rep(0,5000)
for(i in 1:5000)
{
  sam=rnorm(30,6,5)
  res=t.test(sam,mu=6)
  est_mu[i]=mean(sam)
  p_val[i]=broom::tidy(res)$p.value
}
mu_6=data.frame(est_mu,p_val)
```

```{r}
data.frame(mu=0:6,prop=c(sum(mu_0$p_val<0.05)/5000,
                         sum(mu_1$p_val<0.05)/5000,
                         sum(mu_2$p_val<0.05)/5000,
                         sum(mu_3$p_val<0.05)/5000,
                         sum(mu_4$p_val<0.05)/5000,
                         sum(mu_5$p_val<0.05)/5000,
                         sum(mu_6$p_val<0.05)/5000))|>
  ggplot(aes(x=mu,y=prop,fill=mu))+
  geom_bar(stat="identity")+
  labs(
    x="mu",
    y="Proportion",
    color="mu"
  )
```

```{r}
data.frame(mu=0:6,est_mu=c(mean(mu_0$est_mu),
                         mean(mu_1$est_mu),
                         mean(mu_2$est_mu),
                         mean(mu_3$est_mu),
                         mean(mu_4$est_mu),
                         mean(mu_5$est_mu),
                         mean(mu_6$est_mu)))|>
  ggplot(aes(x=mu,y=est_mu,fill=mu))+
  geom_bar(stat="identity")+
  labs(
    x="mu",
    y="Average estimate of mu",
    color="mu"
  )
```

```{r}
data.frame(mu=0:6,prop=c(sum(mu_0$p_val<0.05)/5000,
                         sum(mu_1$p_val<0.05)/5000,
                         sum(mu_2$p_val<0.05)/5000,
                         sum(mu_3$p_val<0.05)/5000,
                         sum(mu_4$p_val<0.05)/5000,
                         sum(mu_5$p_val<0.05)/5000,
                         sum(mu_6$p_val<0.05)/5000))|>
  ggplot(aes(x=mu,y=prop,fill=mu))+
  geom_bar(stat="identity")+
  labs(
    x="mu",
    y="Proportion",
    color="mu"
  )
```

```{r}
data.frame(mu=0:6,est_mu=c(mean(mu_0$est_mu[mu_0$p_val<0.05]),
                         mean(mu_1$est_mu[mu_1$p_val<0.05]),
                         mean(mu_2$est_mu[mu_2$p_val<0.05]),
                         mean(mu_3$est_mu[mu_3$p_val<0.05]),
                         mean(mu_4$est_mu[mu_4$p_val<0.05]),
                         mean(mu_5$est_mu[mu_5$p_val<0.05]),
                         mean(mu_6$est_mu[mu_6$p_val<0.05])))|>
  ggplot(aes(x=mu,y=est_mu,fill=mu))+
  geom_bar(stat="identity")+
  labs(
    x="mu",
    y="Average estimate of mu",
    color="mu"
  )
```



